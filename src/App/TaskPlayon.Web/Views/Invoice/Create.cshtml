@using TaskPlayon.Application.ViewModel
@model InvoiceCreateVm

@{
    ViewData["Title"] = (Model.Id > 0 ? "Edit Invoice" : "Create Invoice");
    var products = ViewBag.Products as List<TaskPlayon.Application.ViewModel.ProductVm>;
}

<h2 class="mb-4">@ViewData["Title"]</h2>

<form method="post" asp-action="@(Model.Id > 0 ? "Edit" : "Create")" asp-route-id="@Model.Id">
    <!-- Customer Info -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">Customer Info</div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Name</label>
                    <input asp-for="CustomerName" class="form-control" />
                    <span asp-validation-for="CustomerName" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input asp-for="CustomerEmail" class="form-control" />
                    <span asp-validation-for="CustomerEmail" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Phone</label>
                    <input asp-for="CustomerPhone" class="form-control" />
                    <span asp-validation-for="CustomerPhone" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Address</label>
                    <input asp-for="CustomerAddress" class="form-control" />
                    <span asp-validation-for="CustomerAddress" class="text-danger"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Items -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <span>Invoice Items</span>
            <button type="button" class="btn btn-light btn-sm" id="addRowBtn">Add Item</button>
        </div>
        <div class="card-body p-0">
            <table class="table table-striped mb-0" id="itemsTable">
                <thead class="table-light">
                    <tr>
                        <th>Product</th>
                        <th width="100">Qty</th>
                        <th width="120">Unit Price</th>
                        <th width="120">Total</th>
                        <th width="50">X</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Items.Count; i++)
                    {
                        <tr>
                            <td>
                                <select name="Items[@i].ProductId" class="form-select product-dd">
                                    <option value="">Select</option>
                                    @foreach (var p in products)
                                    {
                                        <option value="@p.Id" data-price="@p.Price" selected="@(p.Id == Model.Items[i].ProductId)">
                                            @p.Name
                                        </option>
                                    }
                                </select>
                                <span class="text-danger" data-valmsg-for="Items[@i].ProductId" data-valmsg-replace="true"></span>
                            </td>
                            <td>
                                <input type="number" class="form-control qty" name="Items[@i].Quantity" value="@Model.Items[i].Quantity" min="1" />
                                <span class="text-danger" data-valmsg-for="Items[@i].Quantity" data-valmsg-replace="true"></span>
                            </td>
                            <td>
                                <input type="number" class="form-control price" name="Items[@i].UnitPrice" value="@Model.Items[i].UnitPrice" readonly />
                            </td>
                            <td>
                                <span class="lineTotal">@(@Model.Items[i].Quantity * Model.Items[i].UnitPrice)</span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm removeBtn">X</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="card-footer text-end">
            <h5>Total: <span id="grandTotal">0.00</span></h5>
        </div>
    </div>

    <div class="text-end mb-4">
        <button type="submit" class="btn btn-success btn-lg mb-5">Save Invoice</button>
    </div>

    <input type="hidden" asp-for="TotalAmount" id="TotalAmount" />
</form>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.6/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/4.0.0/jquery.validate.unobtrusive.min.js"></script>

    <script>
        let index = @Model.Items.Count;

        // Add new row
        $("#addRowBtn").click(function(){
            let row = `<tr>
                <td>
                    <select name="Items[${index}].ProductId" class="form-select product-dd">
                        <option value="">Select</option>
                        @foreach (var p in products)
                        {
                            <option value="@p.Id" data-price="@p.Price">@p.Name</option>
                        }
                    </select>
                    <span class="text-danger" data-valmsg-for="Items[${index}].ProductId" data-valmsg-replace="true"></span>
                </td>
                <td><input type="number" class="form-control qty" name="Items[${index}].Quantity" value="1" min="1"/>
                    <span class="text-danger" data-valmsg-for="Items[${index}].Quantity" data-valmsg-replace="true"></span>
                </td>
                <td><input type="number" class="form-control price" name="Items[${index}].UnitPrice" value="0" readonly/></td>
                <td><span class="lineTotal">0.00</span></td>
                <td><button type="button" class="btn btn-danger btn-sm removeBtn">X</button></td>
            </tr>`;
            $("#itemsTable tbody").append(row);
            index++;
        });

        // Remove row
        $(document).on("click",".removeBtn",function(){
            $(this).closest("tr").remove();
            updateTotals();
        });

        // Product change
        $(document).on("change",".product-dd",function(){
            let price = $("option:selected", this).data("price") || 0;
            $(this).closest("tr").find(".price").val(price);
            updateTotals();
        });

        // Quantity change
        $(document).on("input",".qty",function(){ updateTotals(); });

        // Calculate totals
        function updateTotals(){
            let total=0;
            $("#itemsTable tbody tr").each(function(){
                let qty=parseFloat($(this).find(".qty").val())||0;
                let price=parseFloat($(this).find(".price").val())||0;
                let line = qty*price;
                $(this).find(".lineTotal").text(line.toFixed(2));
                total += line;
            });
            $("#grandTotal").text(total.toFixed(2));
            $("#TotalAmount").val(total.toFixed(2));
        }

        // Initialize totals on page load
        $(document).ready(function(){ updateTotals(); });
    </script>
}
