@model List<TaskPlayon.Application.ViewModel.InvoiceVm>


<!-- Loader -->
<div id="loader" style="
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(255,255,255,0.6);
    z-index:9999;
    text-align:center;
    padding-top:200px;
">
    <div class="spinner-border text-primary" style="width:4rem; height:4rem;"></div>
    <div class="mt-3">Preparing Download...</div>
</div>

<!-- Hidden iframe for downloads -->
<iframe id="downloadFrame" style="display:none;"></iframe>


<h2>Invoices</h2>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>Customer</th>
            <th>Date</th>
            <th>Total</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var inv in Model)
        {
            <tr>
                <td>@inv.Id</td>
                <td>@inv.CustomerName</td>
                <td>@inv.Date.ToString("dd-MMM-yyyy")</td>
                <td>@inv.Total.ToString("0.00")</td>
                <td>
                    <a asp-action="Edit" asp-controller="Invoice" asp-route-id="@inv.Id" class="btn btn-sm btn-primary">Edit</a>
                    <a asp-action="Details" asp-controller="Invoice" asp-route-id="@inv.Id" class="btn btn-sm btn-info">View</a>
                    <a href="javascript:void(0)"
                       class="btn btn-sm btn-success"
                       onclick="downloadInvoice(@inv.Id)">
                        Print
                    </a>
                </td>
            </tr>
        }
    </tbody>
</table>
<script>
        function downloadInvoice(id) {
        // Show loader
        $("#loader").show();

        $.ajax({
            url: "/invoice/get-download-url",
            type: "GET",
            data: { id: id },
            success: function (response) {

                // Hide loader
                $("#loader").hide();

                // Trigger download using hidden iframe
                $("#downloadFrame").attr("src", response.url);
            },
            error: function () {
                $("#loader").hide();
                Swal.fire("Error", "Failed to generate invoice PDF", "error");
            }
        });
    }

</script>
